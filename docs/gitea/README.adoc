= Gitea How To's

This folder is to host any deployment and/or configurations that were put into place to support this effort.

== Install

* link:install.adoc[Deploy Gitea]

== Configure External SSH

=== Create External Load Balancer (cloud intigrated OCP)
1. `oc create -f gitea-service-ext-lb.yml`

=== Create Vanity FQDN

==== AWS
1. log into aws
2. Route53
3. Hosted Zones
4. Public Zone (rht-set.com.)
5. Create Record Set
   * name: gitea.tssc (.rht-set.com.)
   * Type: A - IPv4 address
   * Alias: Yes
   * Alia Target: Find the ELB that matches the ELB hosting the LoadBalancer FQDN
   * Routing Policy: Simple
   * Evaluate Target Health: No
6. Save Record Set

=== Update Keyclock
1. Log into keyclock
2. Clients
3. Gitea
4. Valid Redirect URIs
5. Add a new entry for the new vanity FQDN (aka, http://gitea.tssc.rht-set.com/*)


=== Update Gitea Config

==== Enable SSH

1. edit the gitea config map with the new FQDN
   1. `oc edit configmap gitea-config -n gitea`
   2. update the following parameters
      * ROOT_URL: update to match vanity fqdn created in the Create Vanity FQDN step (aka, `http://gitea.tssc.rht-set.com`)
      * SSH_DOMAIN: update to match vanity fqdn created in the Create Vanity FQDN step (aka, `gitea.tssc.rht-set.com`)
      * DOMAIN: update to match vanity fqdn created in the Create Vanity FQDN step (aka, `gitea.tssc.rht-set.com`)
   3. save
2. re-deploy gitea to pick up the configmap change
   * `oc rollout latest gitea -n gitea`

==== Persist SSH
Need to add a PVC/PV for the /home/gitea/data dir because that is where the SSH identiy for gitea is stored and iwthout it, every time gitea reboots/pod moves/etc the dientity changes messing up the known_hosts files for clients of gitea.

1. create a PVC
   - name: `gitea-data`
   - size: `Gi
2. Update the `gitea` DeploymentConfig
  1. add a `volumes`
[source,yaml]
----
    - name: gitea-data
      persistentVolumeClaim:
        claimName: gitea-data
----
  2. add `volumeMounts` 
[source,yaml]
----
        - name: gitea-data
          mountPath: /home/gitea/data
----
